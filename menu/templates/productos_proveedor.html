<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Comprar Productos a {{ proveedor.nombre_empresa }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Comprar Productos a {{ proveedor.nombre_empresa }}</h1>
        <form method="post" action="{% url 'crear_compra' proveedor.id_proveedor %}">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-8">
                    <table class="table table-bordered" id="productosTable">
                        <thead>
                            <tr>
                                <th>Foto</th>
                                <th>Nombre del Producto</th>
                                <th>Precio de Costo</th>
                                <th>Cantidad</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for producto in productos %}
                            <tr>
                                <td>
                                    {% if producto.foto_producto %}
                                        <img src="{{ producto.foto_producto.url }}" alt="{{ producto.nombre_producto }}" style="width: 100px;">
                                    {% else %}
                                        No Image
                                    {% endif %}
                                </td>
                                <td>{{ producto.nombre_producto }}</td>
                                <td>
                                    $<span class="precio">{{ producto.precio_costo|floatformat:0 }}</span>
                                    <input type="hidden" name="precio_{{ producto.id_producto }}" value="{{ producto.precio_costo }}">
                                </td>
                                <td>
                                    <div class="input-group">
                                        <button type="button" class="btn btn-outline-secondary decrement">-</button>
                                        <input type="number" name="cantidad_{{ producto.id_producto }}" class="form-control cantidad" data-precio="{{ producto.precio_costo }}" value="0" min="0">
                                        <button type="button" class="btn btn-outline-secondary increment">+</button>
                                    </div>
                                </td>
                                <td>
                                    $<span class="subtotal">0</span>
                                    <input type="hidden" name="subtotal_{{ producto.id_producto }}" class="input-subtotal">
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">Carrito de Compras</div>
                        <div class="card-body">
                            <h5 class="card-title">Orden de Compra</h5>
                            <p class="card-text">Subtotal: $<span id="totalSubtotal">0</span></p>
                            <input type="hidden" name="total_subtotal" id="inputTotalSubtotal">
                            <p class="card-text">IVA: $<span id="totalIVA">0</span></p>
                            <input type="hidden" name="total_iva" id="inputTotalIVA">
                            <p class="card-text">Total: $<span id="grandTotal">0</span></p>
                            <input type="hidden" name="grand_total" id="inputGrandTotal">
                            <button type="submit" class="btn btn-primary">Realizar Compra</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script>
        const updateSubtotals = () => {
            let total = 0;
            document.querySelectorAll('.cantidad').forEach(input => {
                const precio = parseFloat(input.dataset.precio);
                const cantidad = parseInt(input.value);
                const subtotal = precio * cantidad;
                input.closest('tr').querySelector('.subtotal').textContent = subtotal.toFixed(0);
                input.closest('tr').querySelector('.input-subtotal').value = subtotal.toFixed(0);
                total += subtotal;
            });
            const totalIVA = total * 0.19;
            const grandTotal = total + totalIVA;
            document.getElementById('totalSubtotal').textContent = total.toFixed(0);
            document.getElementById('inputTotalSubtotal').value = total.toFixed(0);
            document.getElementById('totalIVA').textContent = totalIVA.toFixed(0);
            document.getElementById('inputTotalIVA').value = totalIVA.toFixed(0);
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(0);
            document.getElementById('inputGrandTotal').value = grandTotal.toFixed(0);
        };

        document.querySelectorAll('.increment').forEach(button => {
            button.addEventListener('click', function() {
                const input = button.closest('.input-group').querySelector('.cantidad');
                input.value = parseInt(input.value) + 1;
                updateSubtotals();
            });
        });

        document.querySelectorAll('.decrement').forEach(button => {
            button.addEventListener('click', function() {
                const input = button.closest('.input-group').querySelector('.cantidad');
                if (parseInt(input.value) > 0) {
                    input.value = parseInt(input.value) - 1;
                    updateSubtotals();
                }
            });
        });

        document.querySelectorAll('.cantidad').forEach(input => {
            input.addEventListener('change', updateSubtotals);
            input.addEventListener('keyup', updateSubtotals);
        });

        // Initialize subtotals on page load
        updateSubtotals();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
